on:  
  push:
    tags:
      - '*' 
  workflow_dispatch:  # click the button on Github repo!

name: Push headless 'rc' as release

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Get recent tag
        id: recentTag
        uses: jimschubert/query-tag-action@v1
        with:
          include: 'v*'

      - name: Show Tag
        id: display
        run: |
          echo 'Output from Find Tag: ${{steps.recentTag.outputs.tag}}'

      - name: Changelog
        uses: scottbrenner/generate-changelog-action@master
        id: Changelog

      - name: Wait on build 'headless'
        uses: tomchv/wait-my-workflow@v1.1.0
        id: wait-build-headless
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          checkName: 'build-release'
          ref: ${{ github.sha }}
          intervalSeconds: 60
          timeoutSeconds: 3600

      # - name: Download artifacts - 'headless'
      #   uses: actions/download-artifact@v2
      #   with:
      #     name: 9c-headless-Linux-${{steps.recentTag.outputs.tag}}

      - name: Download artifacts - 'headless'
        uses: dawidd6/action-download-artifact@v2
        with:
          github_token: ${{secrets.GITHUB_TOKEN}}
          workflow: build_release.yml
          workflow_conclusion: success
          name: 9c-headless-Linux-${{steps.recentTag.outputs.tag}}
          path: ${{ github.workspace }}/9c-headless-Linux-${{steps.recentTag.outputs.tag}}

      - name: Compress files
        run: |
          cd ${{ github.workspace }}/9c-headless-Linux-${{steps.recentTag.outputs.tag}}
          zip -R ${{ github.workspace }}/9c-headless-Linux-${{steps.recentTag.outputs.tag}}.zip *
          cd ${{ github.workspace }}
          ls -la ${{ github.workspace }}
          echo "${{ steps.Changelog.outputs.changelog }}"

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ github.ref }}        
          tag_name: ${{ github.ref }}
          body: |
            ${{ steps.Changelog.outputs.changelog }}
          draft: false
          prerelease: false
          fail_on_unmatched_files: true
          files: |
            9c-headless-Linux-${{steps.recentTag.outputs.tag}}.zip